package main

import (
	"context"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/matryer/is"
)

func TestGetSportsFieldsFromCtxBroker(t *testing.T) {
	is := is.New(t)
	server := setupMockServiceThatReturns(http.StatusOK, sportsfieldsTestData)

	err := GetSportsFields(context.Background(), server.URL, "default")
	is.NoErr(err)
}

func TestGetExerciseTrailsFromCtxBroker(t *testing.T) {
	is := is.New(t)
	server := setupMockServiceThatReturns(http.StatusOK, exerciseTrailsTestData)

	err := GetSportsFields(context.Background(), server.URL, "default")
	is.NoErr(err)
}

func setupMockServiceThatReturns(responseCode int, body string, headers ...func(w http.ResponseWriter)) *httptest.Server {
	return httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		for _, applyHeaderTo := range headers {
			applyHeaderTo(w)
		}

		w.WriteHeader(responseCode)

		if body != "" {
			w.Write([]byte(body))
		}
	}))
}

const sportsfieldsTestData string = `[{"@context":["https://raw.githubusercontent.com/diwise/context-broker/main/assets/jsonldcontexts/default-context.jsonld"],"id":"urn:ngsi-ld:SportsField:se:sundsvall:facilities:796","category":{"type":"Property","value":["skating","floodlit","ice-rink"]},"dateCreated":{"type":"Property","value":{"@type":"DateTime","@value":"2019-10-15T16:15:32Z"}},"dateModified":{"type":"Property","value":{"@type":"DateTime","@value":"2021-12-17T16:54:02Z"}},"description":{"type":"Property","value":"7-manna grusplan intill skolan. Vintertid spolas och snöröjs isbanan en gång i veckan."},"location":{"type":"GeoProperty","value":{"type":"MultiPolygon","coordinates":[[[[17.428771593881844,62.42103804538807],[17.428785133659883,62.421037809376244],[17.428821575900738,62.42048396661722],[17.428101436027845,62.42046508568337],[17.428025378913084,62.42103219129709],[17.428365400350206,62.421045125144],[17.428690864217362,62.421045739009976],[17.428771593881844,62.42103804538807]]]]}},"name":{"type":"Property","value":"Skolans grusplan och isbana"},"source":{"type":"Property","value":"http://127.0.0.1:60519/get/796"},"type":"SportsField"}]`

const exerciseTrailsTestData string = `[{"@context":["https://raw.githubusercontent.com/diwise/context-broker/main/assets/jsonldcontexts/default-context.jsonl"],"areaServed":"Motionsspår Södra spårområdet","category":["floodlit","ski-classic","ski-skate"],"dateCreated":{"@type":"DateTime","@value":"2019-01-23T09:19:21Z"},"dateLastPreparation":{"@type":"DateTime","@value":"2022-04-27T04:07:15Z"},"dateModified":{"@type":"DateTime","@value":"2022-04-19T21:07:15Z"},"description":"Motionsspår med 3 meter bred asfalt för rullskidor, samt 1,5 meter bred grusbädd för promenad\\/löpning\\/cykling. Vintertid enbart skidåkning, med 3 meter skateyta och dubbla klassiska spår. Konstsnöbeläggs.","id":"urn:ngsi-ld:ExerciseTrail:se:sundsvall:facilities:650","length":0.9,"difficulty":0.5,"paymentRequired":"yes","location":{"type":"LineString","coordinates":[[17.308707,62.366359],[17.308765,62.366428],[17.308771,62.366531],[17.308721,62.366609],[17.308607,62.366663],[17.308441,62.366694],[17.308383,62.366694],[17.306906,62.366586],[17.306088,62.366397],[17.305202,62.36618],[17.305029,62.366122],[17.305029,62.366122],[17.304897,62.366023],[17.304829,62.365974],[17.304692,62.365921],[17.304495,62.365868],[17.304495,62.365868],[17.304302,62.365838],[17.30413,62.365807],[17.304103,62.365803],[17.303955,62.365777],[17.303795,62.365758],[17.303445,62.365722],[17.303445,62.365722],[17.303193,62.365681],[17.303048,62.365625],[17.302889,62.365539],[17.302652,62.365347],[17.302417,62.365164],[17.302352,62.365114],[17.302342,62.36508],[17.302342,62.36508],[17.302349,62.36497],[17.302389,62.364906],[17.302561,62.36475],[17.302561,62.36475],[17.302733,62.364548],[17.302854,62.364399],[17.302945,62.364329],[17.303098,62.364281],[17.303098,62.364281],[17.303135,62.364279],[17.303293,62.364284],[17.303298,62.364287],[17.303378,62.364292],[17.303378,62.364292],[17.303461,62.364392],[17.303484,62.364483],[17.303446,62.364708],[17.303448,62.364766],[17.303445,62.364809],[17.303441,62.364884],[17.303458,62.36506],[17.303504,62.365172],[17.303635,62.365288],[17.304366,62.365658],[17.30484,62.365838],[17.305007,62.365893],[17.305228,62.365953],[17.305228,62.365953],[17.305378,62.365992],[17.305508,62.366025],[17.305609,62.366038],[17.305609,62.366038],[17.306497,62.366135],[17.307302,62.366214],[17.307726,62.366252],[17.308231,62.366291],[17.308619,62.366329],[17.308707,62.366359]]},"name":"Motion 1 km Kallaspåret","source":"https://api.sundsvall.se/facilities/2.1/get/650","status":"closed","type":"ExerciseTrail"},{"@context":["https://raw.githubusercontent.com/diwise/context-broker/main/assets/jsonldcontexts/default-context.jsonl"],"areaServed":"Motionsspår Södra spårområdet","category":["floodlit","ski-classic","ski-skate"],"dateCreated":{"@type":"DateTime","@value":"2019-03-26T14:56:10Z"},"dateModified":{"@type":"DateTime","@value":"2022-03-21T09:44:59Z"},"description":"Långt elljusspår runt foten av Södra berget från Sidsjön upp till bergets topp. Passerar Lv5, Hillstamon, Scoutstugan och Stockviks elljusspår","id":"urn:ngsi-ld:ExerciseTrail:se:sundsvall:facilities:669","length":7.4,"location":{"type":"LineString","coordinates":[[17.321818,62.360942],[17.321345,62.360509],[17.321283,62.360459],[17.321152,62.360388],[17.320872,62.360167],[17.32062,62.359959],[17.320529,62.359841],[17.320436,62.359677],[17.320267,62.359503],[17.320136,62.359351],[17.320052,62.359182],[17.319862,62.35888],[17.319804,62.358754],[17.319678,62.358601],[17.319282,62.358439],[17.31926,62.35842],[17.319088,62.35825],[17.318988,62.358137],[17.318938,62.358093],[17.318747,62.357957],[17.318459,62.357803],[17.318122,62.357648],[17.317996,62.357596],[17.317803,62.357517],[17.317717,62.357481],[17.317657,62.357409],[17.317657,62.357409],[17.317634,62.357368],[17.317634,62.357247],[17.317535,62.357151],[17.317483,62.357044],[17.317514,62.356825],[17.317596,62.356778],[17.317694,62.356737],[17.317933,62.356702],[17.318186,62.356684],[17.318314,62.356678],[17.318754,62.356686],[17.318909,62.356671],[17.319002,62.356654],[17.319064,62.356643],[17.319189,62.356602],[17.319286,62.356549],[17.319436,62.356435],[17.319557,62.356315],[17.319777,62.356168],[17.320026,62.356047],[17.32031,62.35593],[17.320751,62.355732],[17.320987,62.355631],[17.321036,62.355585],[17.321081,62.355525],[17.321066,62.355385],[17.321082,62.355344],[17.321252,62.355202],[17.321424,62.355118],[17.321598,62.35491],[17.321783,62.354765],[17.321933,62.354669],[17.322076,62.354603],[17.322329,62.354514],[17.322539,62.354459],[17.322778,62.354417],[17.323046,62.354394],[17.323287,62.354385],[17.323498,62.35439],[17.324014,62.354515],[17.324302,62.354558],[17.324642,62.354567],[17.32484,62.354559],[17.325399,62.354464],[17.325592,62.354437],[17.325797,62.354413],[17.326007,62.354381],[17.326053,62.354366],[17.326212,62.354301],[17.326351,62.354235],[17.326635,62.354096],[17.326866,62.35399],[17.327039,62.353938],[17.327331,62.353874],[17.327603,62.353705],[17.328223,62.353363],[17.328449,62.353265],[17.328656,62.353186],[17.329095,62.353028],[17.329095,62.353028],[17.329309,62.352969],[17.329856,62.352916],[17.330382,62.352898],[17.330608,62.352919],[17.330799,62.352937],[17.331349,62.353048],[17.331811,62.353202],[17.332219,62.35333],[17.332608,62.353542],[17.332854,62.353768],[17.333004,62.353906],[17.333293,62.354128],[17.333628,62.354325],[17.334018,62.354509],[17.334354,62.354658],[17.334354,62.354658],[17.334587,62.354762],[17.335091,62.354957],[17.335359,62.355061],[17.335359,62.355061],[17.335697,62.35519],[17.335895,62.355282],[17.336363,62.355525],[17.336812,62.355768],[17.337305,62.35604],[17.337393,62.356094],[17.337385,62.35609],[17.338027,62.356527],[17.33829,62.356849],[17.33843,62.357142],[17.338534,62.357362],[17.338844,62.357638],[17.338861,62.357947],[17.33899,62.358253],[17.339036,62.358361],[17.339141,62.358472],[17.33939,62.358582],[17.339672,62.358821],[17.339802,62.358912],[17.339962,62.358995],[17.340151,62.359093],[17.340415,62.359212],[17.34053,62.359293],[17.340623,62.35945],[17.340711,62.359515],[17.341184,62.359622],[17.341674,62.359781],[17.341891,62.359923],[17.341969,62.360008],[17.342082,62.360324],[17.342169,62.360555],[17.342301,62.360794],[17.342342,62.3609],[17.342438,62.361129],[17.342455,62.361461],[17.342448,62.36161],[17.342483,62.361741],[17.342578,62.361936],[17.342657,62.362081],[17.342842,62.362337],[17.342977,62.36253],[17.343056,62.362608],[17.343308,62.362852],[17.343445,62.363097],[17.34356,62.363392],[17.343589,62.363628],[17.343536,62.363751],[17.343402,62.363904],[17.34331,62.364043],[17.343273,62.364198],[17.343256,62.36436],[17.34329,62.364478],[17.343581,62.364896],[17.34374,62.365019],[17.343977,62.365162],[17.344282,62.36529],[17.344327,62.365349],[17.344302,62.36554],[17.344201,62.365647],[17.344135,62.365695],[17.344028,62.365776],[17.343972,62.36588],[17.343976,62.365964],[17.343975,62.36596],[17.343976,62.36614],[17.343976,62.366235],[17.343912,62.366381],[17.343612,62.366872],[17.343531,62.366965],[17.343222,62.367175],[17.342829,62.367413],[17.342364,62.367695],[17.342212,62.367776],[17.342151,62.36781],[17.342051,62.367957],[17.341958,62.368082],[17.341663,62.368408],[17.341471,62.368542],[17.341172,62.368687],[17.341153,62.368697],[17.340481,62.368862],[17.340172,62.368931],[17.339849,62.368988],[17.339539,62.36903],[17.339357,62.369079],[17.338813,62.369249],[17.338403,62.369335],[17.338126,62.369395],[17.337986,62.369436],[17.337366,62.369785],[17.337037,62.37],[17.336729,62.370135],[17.336509,62.37021],[17.336514,62.370212],[17.336218,62.370322],[17.335561,62.370634],[17.335148,62.370785],[17.334637,62.370899],[17.334196,62.371037],[17.333816,62.371148],[17.333407,62.371233],[17.332996,62.371357],[17.332648,62.371505],[17.332462,62.371575],[17.332462,62.371575],[17.331536,62.371934],[17.331011,62.372157],[17.330928,62.372206],[17.33091,62.372275],[17.330931,62.372448],[17.33097,62.372581],[17.33111,62.372764],[17.331354,62.372876],[17.33159,62.372919],[17.331981,62.372896],[17.332295,62.372862],[17.332549,62.372858],[17.332601,62.372895],[17.332627,62.372957],[17.332606,62.373021],[17.33248,62.373125],[17.331938,62.373492],[17.331689,62.3737],[17.331474,62.373797],[17.331255,62.373873],[17.331105,62.373907],[17.330884,62.373929],[17.330681,62.373961],[17.330554,62.373992],[17.330333,62.374095],[17.329892,62.374353],[17.329709,62.374462],[17.32948,62.374564],[17.32913,62.374718],[17.329009,62.374771],[17.328663,62.374897],[17.328411,62.375085],[17.328196,62.37523],[17.328024,62.375345],[17.327708,62.375518],[17.327633,62.375563],[17.327633,62.375563],[17.327547,62.375615],[17.327338,62.37571],[17.327086,62.375749],[17.324893,62.375942],[17.323665,62.37606],[17.322861,62.376163],[17.322085,62.376246],[17.321839,62.376261],[17.320522,62.376224],[17.320166,62.376232],[17.319586,62.37629],[17.319389,62.37631],[17.318908,62.376386],[17.318693,62.376411],[17.318249,62.376421],[17.317657,62.376429],[17.317004,62.376417],[17.316274,62.376428],[17.315891,62.376403],[17.31566,62.376429],[17.315087,62.376585],[17.314826,62.376595],[17.314412,62.376597],[17.314024,62.37656],[17.313431,62.376487],[17.313239,62.376458],[17.313239,62.376458],[17.313123,62.376449],[17.312533,62.376358],[17.312085,62.376346],[17.311799,62.37637],[17.311799,62.37637],[17.311496,62.375708],[17.311225,62.375194],[17.31084,62.374794],[17.310521,62.374522],[17.310293,62.374391],[17.309898,62.374104],[17.308825,62.373724],[17.308421,62.373553],[17.308079,62.373402],[17.307316,62.373232],[17.307165,62.373211],[17.307005,62.373214],[17.306792,62.373226],[17.306535,62.373248],[17.306254,62.373282],[17.305744,62.373382],[17.305678,62.373398],[17.305562,62.373424],[17.305491,62.373441],[17.305491,62.373441],[17.305325,62.373468],[17.304916,62.373481],[17.304452,62.373507],[17.304126,62.373507],[17.303411,62.373436],[17.303116,62.373392],[17.30275,62.373318],[17.302555,62.373301],[17.301583,62.373315],[17.301447,62.373333],[17.301355,62.373359],[17.301141,62.373448],[17.301033,62.373519],[17.300591,62.373683],[17.30041,62.373736],[17.299816,62.373839],[17.299311,62.373913],[17.299078,62.37397],[17.298927,62.374055],[17.298824,62.374128],[17.298591,62.374272],[17.298429,62.374407],[17.298382,62.374464],[17.298251,62.374517],[17.297479,62.374658],[17.297328,62.374678],[17.297229,62.374679],[17.297127,62.374671],[17.297024,62.37465],[17.296932,62.374622],[17.296881,62.374596],[17.296796,62.374523],[17.296734,62.374466],[17.296627,62.37441],[17.296469,62.374342],[17.29626,62.374246],[17.296107,62.374165],[17.295844,62.374064],[17.295572,62.373976],[17.29546,62.373932],[17.295306,62.373833],[17.295222,62.373775],[17.295117,62.37368],[17.29499,62.373548],[17.29485,62.373453],[17.294564,62.373315],[17.294352,62.373219],[17.294352,62.373219],[17.293685,62.373055],[17.2935,62.373014],[17.293425,62.373008],[17.293244,62.372992],[17.29313,62.372989],[17.293041,62.372993],[17.2929,62.373007],[17.292647,62.37304],[17.292326,62.373092],[17.291992,62.373166],[17.291773,62.373243],[17.29148,62.37337],[17.291212,62.373491],[17.290992,62.373602],[17.29082,62.373715],[17.290445,62.374019],[17.29029,62.37412],[17.290081,62.374231],[17.289944,62.374278],[17.28972,62.374332],[17.289508,62.374356],[17.289338,62.374359],[17.289182,62.374355],[17.289079,62.37435],[17.28887,62.374325],[17.288325,62.374186],[17.288149,62.374156],[17.287639,62.374109],[17.287158,62.374017],[17.287107,62.374003],[17.286541,62.373749],[17.286246,62.373599],[17.286081,62.37355],[17.285846,62.373508],[17.28549,62.373493],[17.285262,62.373531],[17.284946,62.3736],[17.284565,62.37371],[17.284118,62.373862]]},"name":"Sidsjön-Lv5-Scoutstugan-Södra Berget","source":"https://api.sundsvall.se/facilities/2.1/get/669","status":"closed","type":"ExerciseTrail"}]`
